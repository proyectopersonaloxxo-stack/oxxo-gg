<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reportes OXXO</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes e Iconos Nuevos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Estilos mejorados */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .contenedor { 
            max-width: 700px; 
            margin: 50px auto; 
            padding: 0; 
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden; 
            border-top: 4px solid #E61C2D; /* Borde superior OXXO */
        }
        
        /* Mensajes de éxito y error */
        .success { background-color: #dcfce7; border-left-width: 4px; border-color: #22c55e; color: #166534; padding: 1rem; }
        .error { background-color: #ffebee; border-left-width: 4px; border-color: #ef4444; color: #b91c1c; padding: 1rem; }
        
        /* Estilo para inputs con icono */
        .input-con-icono { position: relative; }
        .input-con-icono i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af; /* gray-400 */
            width: 20px;
            height: 20px;
        }
        .input-con-icono input, .input-con-icono-select select { 
            padding-left: 2.75rem; /* pl-11 */
            border-radius: 0.5rem; /* rounded-lg */
            border-color: #d1d5db; /* border-gray-300 */
            padding-top: 0.75rem; /* py-3 */
            padding-bottom: 0.75rem;
        }
        .input-con-icono input:focus, .input-con-icono-select select:focus {
            border-color: #E61C2D;
            box-shadow: 0 0 0 2px rgba(230, 28, 45, 0.2);
            outline: none;
        }
        
        /* Estilos para el input de prioridad deshabilitado */
        .input-con-icono input[disabled] {
            background-color: #f9fafb; /* bg-gray-50 */
            font-weight: 600;
            cursor: not-allowed;
        }
        .prioridad-Alta { color: #b91c1c; border-color: #fca5a5; background-color: #fee2e2; }
        .prioridad-Media { color: #b45309; border-color: #fdba74; background-color: #fffbeb; }
        .prioridad-Baja { color: #15803d; border-color: #86efac; background-color: #f0fdf4; }

        /* Botón primario con mejores efectos */
        .btn-primary {
            background-color: #E61C2D;
            color: white;
            font-weight: 600; /* semibold */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(230, 28, 45, 0.2), 0 2px 4px -1px rgba(230, 28, 45, 0.1);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #c41220;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(230, 28, 45, 0.2), 0 4px 6px -2px rgba(230, 28, 45, 0.1);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Animación para el spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Estilo para los botones de IA */
        .btn-ia {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-ia:hover:not(:disabled) {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-ia:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="contenedor">
        <header class="text-center p-6 md:p-8 border-b border-gray-100">
            
            <div class="flex justify-center mb-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/66/Oxxo_Logo.svg" alt="OXXO Logo" class="h-12 w-auto">
            </div>

            <h1 class="text-3xl font-bold text-gray-800">Generador de Reporte OXXO</h1>
            <p class="text-gray-500 mt-2 text-sm">Sistemas y Enlaces - Servidor Online</p>
        </header>

        <!-- FORMULARIO DE REPORTE (SIEMPRE VISIBLE) -->
        <div id="formulario-container" class="p-6 md:p-8">
            
            <!-- CONTENEDOR DE MENSAJES -->
            <div id="mensaje-servidor" class="hidden mb-4 rounded-lg text-sm font-medium"></div>
            
            <form id="reporte-form" class="space-y-6">

                <!-- Fila 1: Tienda, Correo, Quien Reporta -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <!-- CR / Plaza / Tienda -->
                    <div>
                        <label for="tienda" class="block text-sm font-medium text-gray-700 mb-1">CR / Plaza / Tienda</label>
                        <div class="input-con-icono mt-1">
                            <i data-lucide="store"></i>
                            <input type="text" id="tienda" name="tienda" class="w-full p-3 border rounded-md focus:ring-red-500 focus:border-red-500 uppercase" placeholder="EJ: 10MON - Monclova C.">
                        </div>
                    </div>
                    
                    <!-- Correo del Proveedor -->
                    <div>
                        <label for="correo_proveedor" class="block text-sm font-medium text-gray-700 mb-1">Correo Proveedor</label>
                        <div class="input-con-icono mt-1">
                            <i data-lucide="mail"></i>
                            <input type="email" id="correo_proveedor" name="correo_proveedor" placeholder="soporte.ti@ejemplo.com" class="w-full p-3 border rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>

                    <!-- Quien Reporta (NUEVO CAMPO) -->
                    <div>
                        <label for="quien_reporta" class="block text-sm font-medium text-gray-700 mb-1">Quien Reporta</label>
                        <div class="input-con-icono mt-1">
                            <i data-lucide="user"></i>
                            <input type="text" id="quien_reporta" name="quien_reporta" placeholder="Tu Nombre" class="w-full p-3 border rounded-md focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                </div>

                <!-- Fila 2: Categoría y Prioridad -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 input-con-icono-select">
                    <!-- Categoría -->
                    <div>
                        <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría del Reporte</label>
                        <select id="categoria" name="categoria" class="w-full p-3 mt-1 border rounded-md focus:ring-red-500 focus:border-red-500">
                            <option value="">-- Seleccione una Categoría --</option>
                            <option value="Fallo de Equipo">Fallo de Equipo (POS, Handheld, Tablet)</option>
                            <option value="Servicio/Aplicación">Fallo de Servicio (Depósitos, Pagos)</option>
                            <option value="Daño a Tienda">Daño a Tienda (Vidrios, Puertas, Fachada)</option>
                            <option value="Reporte de Enlaces">Reporte de Revisión de Enlaces</option>
                        </select>
                    </div>

                    <!-- Prioridad Automática (ya no es manual) -->
                    <div>
                        <label for="prioridad_display" class="block text-sm font-medium text-gray-700 mb-1">Prioridad Asignada</label>
                        <div class="input-con-icono mt-1">
                            <i data-lucide="alert-triangle"></i>
                            <input type="text" id="prioridad_display" name="prioridad_display" class="w-full p-3 border rounded-md" value="-- Seleccione Categoría --" disabled>
                            <!-- Campo oculto que SÍ se envía al servidor -->
                            <input type="hidden" id="prioridad_hidden" name="prioridad" value="">
                        </div>
                    </div>
                </div>

                <!-- Fila 3: Detalles (Textarea) -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="detalles" class="block text-sm font-medium text-gray-700">Descripción del Reporte</label>
                        <button type="button" id="btn-mejorar-ia" class="btn-ia text-xs flex items-center gap-1" disabled>
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span id="btn-ia-text">Mejorar Texto con IA</span>
                        </button>
                    </div>
                    <textarea id="detalles" name="detalles" rows="8" class="w-full p-3 mt-1 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 font-mono text-sm" placeholder="Describa el problema aquí..."></textarea>
                    <p id="plantilla-cargada" class="text-xs text-gray-500 text-right mt-1 hidden">Plantilla cargada.</p>
                    <input type="hidden" id="resumen_ejecutivo_hidden" name="resumen_ejecutivo" value="">
                </div>

                <!-- Fila 4: Botón de Envío -->
                <div class="pt-2 text-right">
                    <button type="submit" id="btn-enviar" class="btn-primary inline-flex items-center justify-center gap-2 w-full md:w-auto">
                        <span id="btn-icon"><i data-lucide="send" class="w-5 h-5"></i></span>
                        <span id="btn-text">Enviar Reporte</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // ----------------------------------------------------------------------------------
        // IMPORTANTE: DEBES CAMBIAR ESTA URL DESPUÉS DE SUBIR TU SERVIDOR PYTHON A LA NUBE
        // Esta es la URL de tu servicio de Render
        // ----------------------------------------------------------------------------------
        const SERVER_URL_BASE = 'https://oxxo-gg.onrender.com'; // <--- LÍNEA 319
        // ----------------------------------------------------------------------------------

        const detallesTextarea = document.getElementById('detalles');
        const categoriaSelect = document.getElementById('categoria');
        const form = document.getElementById('reporte-form');
        const mensajeServidor = document.getElementById('mensaje-servidor');
        const plantillaMsg = document.getElementById('plantilla-cargada');
        const btnEnviar = document.getElementById('btn-enviar');
        const btnIcon = document.getElementById('btn-icon');
        const btnText = document.getElementById('btn-text');
        const prioridadDisplay = document.getElementById('prioridad_display');
        const prioridadHidden = document.getElementById('prioridad_hidden');
        const resumenHidden = document.getElementById('resumen_ejecutivo_hidden');
        const btnMejorarIA = document.getElementById('btn-mejorar-ia');
        const btnIAText = document.getElementById('btn-ia-text');

        // URL y API Key para Gemini
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
        const apiKey = ""; // API key se proporciona automáticamente en Canvas.

        // Objeto con las plantillas
        const plantillas = {
            'Fallo de Equipo': 'Equipo Afectado: \nMarca y Modelo: \nNúmero de Serie: \nDescripción del Fallo:',
            'Servicio/Aplicación': 'Servicio afectado (Depósitos, Pagos, App): \nHora del Fallo: \nDescripción del error o mensaje en pantalla:',
            'Daño a Tienda': '[REPORTE DE DAÑOS]\n----------------------------------\n- ÁREA AFECTADA: [EJ: Fachada, Baños, Piso de venta]\n- TIPO DE DAÑO: [EJ: Vidrio roto, Fuga de agua, Grafiti]\n- ¿AFECTA OPERACIÓN?: [Sí/No]\n\nOBSERVACIONES:',
            'Reporte de Enlaces': 'Adjunto se envía la plantilla de revisión de enlaces.\nSolicitamos que revisen los enlaces marcados en ROJO y confirmen su estado o la fecha de reparación.\n\nDetalles adicionales (Opcional):'
        };

        // Función para manejar el estado de los botones (enviando o cargando IA)
        function setButtonState(button, isLoading, initialIcon, initialText, loadingText) {
            button.disabled = isLoading;
            const iconSpan = button.querySelector('i');
            button.innerHTML = `<span id="btn-icon">${isLoading ? '<i data-lucide="loader-2" class="w-4 h-4 spinner"></i>' : `<i data-lucide="${initialIcon}" class="w-4 h-4"></i>`}</span> ${isLoading ? loadingText : initialText}`;
            lucide.createIcons();
        }

        // Función de Mejora de Texto con IA (Gemini)
        btnMejorarIA.addEventListener('click', async () => {
            const textoOriginal = detallesTextarea.value.trim();
            if (!textoOriginal || textoOriginal === 'Describa el problema aquí...') {
                mostrarMensaje('error', 'Escribe primero los detalles del reporte para que la IA pueda mejorarlos.', 5000);
                return;
            }

            setButtonState(btnMejorarIA, true, 'sparkles', 'Mejorar Texto con IA', 'Analizando...');
            
            const systemPrompt = "Actúa como un agente de soporte técnico de OXXO. Recibirás un texto informal o con errores. Tu trabajo es reescribirlo para que sea profesional, claro y conciso, manteniendo todos los detalles clave. NO añadas el encabezado de la plantilla, solo el texto mejorado.";
            const userQuery = `Reescribe de forma profesional el siguiente reporte de tienda: "${textoOriginal}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const textoMejorado = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (textoMejorado) {
                    detallesTextarea.value = textoMejorado;
                    mostrarMensaje('success', '✅ Descripción del reporte mejorada con éxito por IA.', 5000);
                } else {
                    mostrarMensaje('error', '❌ La IA no pudo generar una mejora. Intenta con un texto más largo.', 5000);
                }

            } catch (error) {
                console.error('Error al llamar a Gemini API (Mejorar Texto):', error);
                mostrarMensaje('error', 'Error de conexión con el servicio de IA. Intenta de nuevo.', 5000);
            } finally {
                setButtonState(btnMejorarIA, false, 'sparkles', 'Mejorar Texto con IA', 'Analizando...');
                // Restaurar el icono de envío si no estaba cargando
                btnIcon.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i>';
                lucide.createIcons();
            }
        });


        // Función que asigna plantilla, prioridad y activa/desactiva botones
        categoriaSelect.addEventListener('change', () => {
            const categoria = categoriaSelect.value;
            let plantilla = '';
            let prioridadAsignada = '';
            let prioridadClase = '';
            
            plantillaMsg.classList.add('hidden'); // Oculta el mensaje
            btnMejorarIA.disabled = categoria === '';

            // Lógica de Prioridad Automática
            switch (categoria) {
                case 'Fallo de Equipo':
                case 'Servicio/Aplicación':
                    plantilla = plantillas[categoria] || '';
                    prioridadAsignada = 'Alta';
                    prioridadClase = 'prioridad-Alta';
                    break;
                case 'Daño a Tienda':
                    plantilla = plantillas[categoria] || '';
                    prioridadAsignada = 'Media';
                    prioridadClase = 'prioridad-Media';
                    break;
                case 'Reporte de Enlaces':
                    plantilla = plantillas[categoria] || '';
                    prioridadAsignada = 'Baja';
                    prioridadClase = 'prioridad-Baja';
                    break;
                default:
                    plantilla = 'Describa el problema aquí...';
                    prioridadAsignada = '';
                    prioridadClase = '';
                    break;
            }
            detallesTextarea.value = plantilla;
            
            // Asignar valores a los campos de prioridad
            prioridadDisplay.value = prioridadAsignada || '-- Seleccione Categoría --';
            prioridadHidden.value = prioridadAsignada;
            
            // Cambiar el color del campo de prioridad
            prioridadDisplay.classList.remove('prioridad-Alta', 'prioridad-Media', 'prioridad-Baja');
            if (prioridadClase) {
                prioridadDisplay.classList.add(prioridadClase);
            }
            
            if(categoria !== '') {
                plantillaMsg.textContent = `Plantilla para "${categoria}" cargada.`;
                plantillaMsg.classList.remove('hidden');
            }
        });


        // FUNCIÓN CLAVE: Envío al Servidor Python y Generación de Resumen Ejecutivo (Gemini)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tiendaInput = document.getElementById('tienda');
            const quienReportaInput = document.getElementById('quien_reporta');
            const correoProveedorInput = document.getElementById('correo_proveedor');
            
            // Validación
            if (!tiendaInput.value || !quienReportaInput.value || !categoriaSelect.value || !correoProveedorInput.value || !detallesTextarea.value || !prioridadHidden.value) {
                mostrarMensaje('error', 'Por favor, complete todos los campos requeridos (incluyendo el cuerpo del reporte y la categoría).', 5000);
                return;
            }
            
            // 1. Mostrar estado de CARGANDO (SUMARIZANDO)
            setButtonState(btnEnviar, true, 'send', 'Enviar Reporte', 'Generando Resumen IA...');
            
            // Deshabilitar botón de IA para evitar doble click
            btnMejorarIA.disabled = true;

            let resumenEjecutivo = 'Resumen no disponible.';
            const textoParaResumir = detallesTextarea.value.trim();

            // 2. Generar el Resumen Ejecutivo con Gemini
            if (textoParaResumir.length > 50) {
                const systemPromptResumen = "Eres un analista de soporte crítico. Recibirás un reporte detallado. Tu tarea es generar un ÚNICO resumen conciso, de no más de 15 palabras, para ser usado como ASUNTO de correo. Enfócate en la acción y el impacto. NO uses encabezados, solo el texto.";
                const userQueryResumen = `Genera un resumen ejecutivo para este reporte: "${textoParaResumir}"`;

                const payloadResumen = {
                    contents: [{ parts: [{ text: userQueryResumen }] }],
                    systemInstruction: { parts: [{ text: systemPromptResumen }] },
                };

                try {
                    const responseResumen = await fetch(GEMINI_API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadResumen)
                    });

                    const resultResumen = await responseResumen.json();
                    resumenEjecutivo = resultResumen.candidates?.[0]?.content?.parts?.[0]?.text || 'Resumen no generado por IA.';
                } catch (error) {
                    console.error('Error en API de Resumen:', error);
                    resumenEjecutivo = 'Resumen no generado (Fallo de IA).';
                }
            } else {
                 resumenEjecutivo = 'Texto demasiado corto para resumir.';
            }

            // 3. Preparar los datos finales para el servidor Python
            const data = {
                tienda: tiendaInput.value.toUpperCase(),
                quien_reporta: quienReportaInput.value,
                categoria: categoriaSelect.value,
                prioridad: prioridadHidden.value,
                correo_proveedor: correoProveedorInput.value,
                detalles: detallesTextarea.value,
                resumen_ejecutivo: resumenEjecutivo // <--- Campo crucial para el asunto y CSV
            };

            // 4. Mostrar estado de CARGANDO (ENVIANDO)
            setButtonState(btnEnviar, true, 'send', 'Enviar Reporte', 'Enviando Reporte...');


            // 5. Envío al Servidor Python
            try {
                const response = await fetch(SERVER_URL_BASE + '/enviar_correo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarMensaje('success', result.mensaje, 7000);
                    form.reset(); 
                    plantillaMsg.classList.add('hidden'); 
                    prioridadDisplay.value = '-- Seleccione Categoría --';
                    prioridadDisplay.classList.remove('prioridad-Alta', 'prioridad-Media', 'prioridad-Baja');
                    prioridadHidden.value = '';
                } else {
                    mostrarMensaje('error', result.error, 10000);
                }
            } catch (error) {
                console.error('Error al enviar a Flask:', error);
                mostrarMensaje('error', `Error de conexión: El servidor Python online no está activo o hay un error.`, 10000);
            } finally {
                // Restaurar botones
                setButtonState(btnEnviar, false, 'send', 'Enviar Reporte', 'Enviando Reporte...');
                btnMejorarIA.disabled = false;
            }
        });

        // Función para mostrar mensajes
        function mostrarMensaje(tipo, texto, duracion) {
            mensajeServidor.textContent = texto;
            mensajeServidor.classList.remove('hidden', 'success', 'error');
            
            if (tipo === 'success') {
                mensajeServidor.classList.add('success');
            } else {
                mensajeServidor.classList.add('error');
            }
            mensajeServidor.classList.remove('hidden');

            setTimeout(() => {
                mensajeServidor.classList.add('hidden');
            }, duracion);
        }

        // Inicializar iconos y estado al cargar
        window.onload = () => { 
            lucide.createIcons();
        };

    </script>
</body>
</html>
